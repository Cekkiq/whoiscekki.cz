<%- include('../partials/header', { title: 'Special Codes | Admin Panel' }) %>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Special Codes</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCodeModal">
      Create New Code
    </button>
  </div>

  <div class="card">
    <div class="card-body">
      <% if (codes.length === 0) { %>
        <p class="text-muted text-center my-4">No special codes created yet.</p>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Code</th>
                <th>GB Amount</th>
                <th>Uses</th>
                <th>Max Uses</th>
                <th>Created By</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% codes.forEach(code => { %>
                <tr>
                  <td><code><%= code.code %></code></td>
                  <td><%= code.gb_amount %></td>
                  <td><%= code.use_count %></td>
                  <td><%= code.max_uses === 0 ? 'Unlimited' : code.max_uses %></td>
                  <td><%= code.creator || 'System' %></td>
                  <td><%= new Date(code.created_at).toLocaleString() %></td>
                  <td>
                    <button class="btn btn-sm btn-danger delete-code" data-id="<%= code.id %>">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Create Code Modal -->
<div class="modal fade" id="createCodeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="createCodeForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="code" class="form-label">Code</label>
            <input type="text" class="form-control" id="code" name="code" required>
            <div class="form-text">The code users will enter to redeem</div>
          </div>
          <div class="mb-3">
            <label for="gbAmount" class="form-label">GB Amount</label>
            <input type="number" step="0.1" min="0.1" class="form-control" id="gbAmount" name="gbAmount" required>
            <div class="form-text">Amount of GB to add (e.g., 5 or 2.5)</div>
          </div>
          <div class="mb-3">
            <label for="maxUses" class="form-label">Max Uses (Optional)</label>
            <input type="number" min="1" class="form-control" id="maxUses" name="maxUses">
            <div class="form-text">Leave empty for single use</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Code</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>

<!-- JavaScript for handling form submission -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const createForm = document.getElementById('createCodeForm');
  
  // Handle form submission
  createForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(createForm);
    const data = Object.fromEntries(formData.entries());
    
    try {
      const response = await fetch('/AdminPanel/special-codes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Reload the page to show the new code
        window.location.reload();
      } else {
        alert(result.error || 'Error creating code');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred while creating the code');
    }
  });
  
  // Handle delete buttons
  document.querySelectorAll('.delete-code').forEach(button => {
    button.addEventListener('click', async function() {
      const codeId = this.getAttribute('data-id');
      
      if (!confirm('Are you sure you want to delete this code?')) {
        return;
      }
      
      try {
        const response = await fetch(`/AdminPanel/special-codes/${codeId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Remove the row from the table
          this.closest('tr').remove();
        } else {
          alert(result.error || 'Error deleting code');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while deleting the code');
      }
    });
  });
});
</script>
